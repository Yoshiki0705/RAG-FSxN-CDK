name: 'Run Integration Tests'
description: 'Permission-aware RAG Systemçµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ'
author: 'NetApp Japan Technology Team'

inputs:
  test-mode:
    description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ (quick/full)'
    required: false
    default: 'quick'
  
  environment:
    description: 'å®Ÿè¡Œç’°å¢ƒ (demo/local/ec2/staging)'
    required: false
    default: 'demo'
  
  aws-profile:
    description: 'AWSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«'
    required: false
    default: 'user01'
  
  aws-region:
    description: 'AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³'
    required: false
    default: 'us-east-1'
  
  output-format:
    description: 'å‡ºåŠ›å½¢å¼ (junit/json/both/console)'
    required: false
    default: 'junit'
  
  verbose:
    description: 'è©³ç´°ãƒ­ã‚°å‡ºåŠ›'
    required: false
    default: 'false'
  
  parallel:
    description: 'ä¸¦åˆ—å®Ÿè¡Œ'
    required: false
    default: 'false'

outputs:
  total-tests:
    description: 'ç·ãƒ†ã‚¹ãƒˆæ•°'
    value: ${{ steps.run-tests.outputs.total-tests }}
  
  passed-tests:
    description: 'æˆåŠŸãƒ†ã‚¹ãƒˆæ•°'
    value: ${{ steps.run-tests.outputs.passed-tests }}
  
  failed-tests:
    description: 'å¤±æ•—ãƒ†ã‚¹ãƒˆæ•°'
    value: ${{ steps.run-tests.outputs.failed-tests }}
  
  success-rate:
    description: 'ãƒ†ã‚¹ãƒˆæˆåŠŸçŽ‡'
    value: ${{ steps.run-tests.outputs.success-rate }}
  
  execution-time:
    description: 'å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰'
    value: ${{ steps.run-tests.outputs.execution-time }}
  
  exit-code:
    description: 'çµ‚äº†ã‚³ãƒ¼ãƒ‰'
    value: ${{ steps.run-tests.outputs.exit-code }}

runs:
  using: 'composite'
  steps:
    - name: Setup test environment
      shell: bash
      run: |
        echo "ðŸš€ çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p development/logs/testing
        mkdir -p test-results
        
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
        chmod +x development/scripts/testing/quick_integration_test.sh
        chmod +x development/scripts/testing/ci-integration.sh
        
        # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        echo "CI_MODE=true" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
        echo "AWS_PROFILE=${{ inputs.aws-profile }}" >> $GITHUB_ENV
        echo "AWS_REGION=${{ inputs.aws-region }}" >> $GITHUB_ENV

    - name: Run integration tests
      id: run-tests
      shell: bash
      run: |
        echo "ðŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹"
        echo "  ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ inputs.test-mode }}"
        echo "  å®Ÿè¡Œç’°å¢ƒ: ${{ inputs.environment }}"
        echo "  å‡ºåŠ›å½¢å¼: ${{ inputs.output-format }}"
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰
        test_options="--mode ${{ inputs.test-mode }}"
        test_options="$test_options --environment ${{ inputs.environment }}"
        test_options="$test_options --profile ${{ inputs.aws-profile }}"
        test_options="$test_options --region ${{ inputs.aws-region }}"
        test_options="$test_options --output-format ${{ inputs.output-format }}"
        test_options="$test_options --ci-mode"
        
        if [[ "${{ inputs.verbose }}" == "true" ]]; then
          test_options="$test_options --verbose"
        fi
        
        if [[ "${{ inputs.parallel }}" == "true" ]]; then
          test_options="$test_options --parallel"
        fi
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        set +e  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶š
        ./development/scripts/testing/quick_integration_test.sh $test_options > test_output.log 2>&1
        exit_code=$?
        set -e
        
        echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        # ãƒ†ã‚¹ãƒˆçµæžœã®è§£æž
        if [[ -f "test_output.log" ]]; then
          # çµæžœã®æŠ½å‡º
          total_tests=$(grep -o "ç·ãƒ†ã‚¹ãƒˆæ•°: [0-9]*" test_output.log | grep -o "[0-9]*" | head -1 || echo "0")
          passed_tests=$(grep -o "æˆåŠŸ: [0-9]*" test_output.log | grep -o "[0-9]*" | head -1 || echo "0")
          failed_tests=$(grep -o "å¤±æ•—: [0-9]*" test_output.log | grep -o "[0-9]*" | head -1 || echo "0")
          execution_time=$(grep -o "ç·å®Ÿè¡Œæ™‚é–“: [0-9]*ms" test_output.log | grep -o "[0-9]*" | head -1 || echo "0")
          
          # æˆåŠŸçŽ‡è¨ˆç®—
          if [[ $total_tests -gt 0 ]]; then
            success_rate=$(echo "scale=2; $passed_tests * 100 / $total_tests" | bc -l)
          else
            success_rate="0"
          fi
          
          # GitHub Actionså‡ºåŠ›
          echo "total-tests=$total_tests" >> $GITHUB_OUTPUT
          echo "passed-tests=$passed_tests" >> $GITHUB_OUTPUT
          echo "failed-tests=$failed_tests" >> $GITHUB_OUTPUT
          echo "success-rate=$success_rate" >> $GITHUB_OUTPUT
          echo "execution-time=$execution_time" >> $GITHUB_OUTPUT
          
          # çµæžœã‚µãƒžãƒªãƒ¼ã®è¡¨ç¤º
          echo "ðŸ“Š ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼:"
          echo "  ç·ãƒ†ã‚¹ãƒˆæ•°: $total_tests"
          echo "  æˆåŠŸ: $passed_tests"
          echo "  å¤±æ•—: $failed_tests"
          echo "  æˆåŠŸçŽ‡: $success_rate%"
          echo "  å®Ÿè¡Œæ™‚é–“: ${execution_time}ms"
          echo "  çµ‚äº†ã‚³ãƒ¼ãƒ‰: $exit_code"
        else
          echo "âš ï¸ ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "total-tests=0" >> $GITHUB_OUTPUT
          echo "passed-tests=0" >> $GITHUB_OUTPUT
          echo "failed-tests=0" >> $GITHUB_OUTPUT
          echo "success-rate=0" >> $GITHUB_OUTPUT
          echo "execution-time=0" >> $GITHUB_OUTPUT
        fi
        
        # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®å‡¦ç†
        if [[ $exit_code -ne 0 ]]; then
          echo "âŒ çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯test_output.logã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        else
          echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ inputs.test-mode }}-${{ github.run_number }}
        path: |
          test_output.log
          development/logs/testing/
          test-results/
        retention-days: 30

    - name: Generate test report
      if: always()
      shell: bash
      run: |
        echo "ðŸ“„ ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
        
        # GitHub Actions ã‚µãƒžãƒªãƒ¼ã®ç”Ÿæˆ
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆçµæžœ (${{ inputs.test-mode }}ãƒ¢ãƒ¼ãƒ‰)
        
        | é …ç›® | å€¤ |
        |------|-----|
        | ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ | ${{ inputs.test-mode }} |
        | å®Ÿè¡Œç’°å¢ƒ | ${{ inputs.environment }} |
        | ç·ãƒ†ã‚¹ãƒˆæ•° | ${{ steps.run-tests.outputs.total-tests }} |
        | æˆåŠŸ | ${{ steps.run-tests.outputs.passed-tests }} |
        | å¤±æ•— | ${{ steps.run-tests.outputs.failed-tests }} |
        | æˆåŠŸçŽ‡ | ${{ steps.run-tests.outputs.success-rate }}% |
        | å®Ÿè¡Œæ™‚é–“ | ${{ steps.run-tests.outputs.execution-time }}ms |
        | çµ‚äº†ã‚³ãƒ¼ãƒ‰ | ${{ steps.run-tests.outputs.exit-code }} |
        
        $(if [[ "${{ steps.run-tests.outputs.exit-code }}" == "0" ]]; then echo "âœ… **ãƒ†ã‚¹ãƒˆæˆåŠŸ**"; else echo "âŒ **ãƒ†ã‚¹ãƒˆå¤±æ•—**"; fi)
        
        ### ðŸ“ ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ
        - ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãƒ­ã‚°: \`test_output.log\`
        - è©³ç´°ãƒ­ã‚°: \`development/logs/testing/\`
        - ãƒ†ã‚¹ãƒˆçµæžœ: \`test-results/\`
        EOF

    - name: Fail if tests failed
      if: steps.run-tests.outputs.exit-code != '0'
      shell: bash
      run: |
        echo "âŒ çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: ${{ steps.run-tests.outputs.exit-code }})"
        exit ${{ steps.run-tests.outputs.exit-code }}