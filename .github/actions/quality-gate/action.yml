name: 'Quality Gate'
description: 'Permission-aware RAG Systemå“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š'
author: 'NetApp Japan Technology Team'

inputs:
  test-results-path:
    description: 'ãƒ†ã‚¹ãƒˆçµæžœJSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
    required: true
  
  environment:
    description: 'å®Ÿè¡Œç’°å¢ƒ (development/staging/production)'
    required: false
    default: 'staging'
  
  config-path:
    description: 'å“è³ªã‚²ãƒ¼ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
    required: false
    default: 'config/quality-gate/quality-gate.yml'
  
  output-path:
    description: 'ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ãƒ‘ã‚¹'
    required: false
    default: 'quality-reports/quality-report.md'
  
  fail-on-quality-gate:
    description: 'å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—æ™‚ã«ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹ã‹'
    required: false
    default: 'true'

outputs:
  gate-status:
    description: 'å“è³ªã‚²ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (PASS/WARN/FAIL)'
    value: ${{ steps.evaluate-quality.outputs.gate-status }}
  
  overall-score:
    description: 'ç·åˆå“è³ªã‚¹ã‚³ã‚¢'
    value: ${{ steps.evaluate-quality.outputs.overall-score }}
  
  blocking-failures:
    description: 'ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¤±æ•—ã®æ•°'
    value: ${{ steps.evaluate-quality.outputs.blocking-failures }}
  
  warnings:
    description: 'è­¦å‘Šã®æ•°'
    value: ${{ steps.evaluate-quality.outputs.warnings }}
  
  report-path:
    description: 'ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‘ã‚¹'
    value: ${{ steps.evaluate-quality.outputs.report-path }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      shell: bash
      run: |
        echo "ðŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        pip install --quiet pyyaml

    - name: Prepare quality gate environment
      shell: bash
      run: |
        echo "ðŸ”§ å“è³ªã‚²ãƒ¼ãƒˆç’°å¢ƒã‚’æº–å‚™ä¸­..."
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        mkdir -p quality-reports
        mkdir -p test-results
        
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
        chmod +x scripts/ci/quality-gate.py
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [[ ! -f "${{ inputs.config-path }}" ]]; then
          echo "âš ï¸ å“è³ªã‚²ãƒ¼ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ inputs.config-path }}"
          echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™"
        fi
        
        # ãƒ†ã‚¹ãƒˆçµæžœãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [[ ! -f "${{ inputs.test-results-path }}" ]]; then
          echo "âŒ ãƒ†ã‚¹ãƒˆçµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ inputs.test-results-path }}"
          echo "ãƒ€ãƒŸãƒ¼ã®ãƒ†ã‚¹ãƒˆçµæžœã‚’ä½œæˆã—ã¾ã™"
          
          cat > "${{ inputs.test-results-path }}" << 'EOF'
        {
          "summary": {
            "total_tests": 0,
            "passed_tests": 0,
            "failed_tests": 0,
            "success_rate": 0,
            "execution_time_ms": 0
          }
        }
        EOF
        fi

    - name: Evaluate quality metrics
      id: evaluate-quality
      shell: bash
      run: |
        echo "ðŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹è©•ä¾¡ã‚’å®Ÿè¡Œä¸­..."
        echo "  ç’°å¢ƒ: ${{ inputs.environment }}"
        echo "  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ${{ inputs.config-path }}"
        echo "  ãƒ†ã‚¹ãƒˆçµæžœ: ${{ inputs.test-results-path }}"
        
        # å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè¡Œ
        set +e  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶š
        python3 scripts/ci/quality-gate.py \
          --config "${{ inputs.config-path }}" \
          --environment "${{ inputs.environment }}" \
          --test-results "${{ inputs.test-results-path }}" \
          --output "${{ inputs.output-path }}" \
          --verbose > quality_gate_output.json 2>&1
        
        quality_gate_exit_code=$?
        set -e
        
        echo "å“è³ªã‚²ãƒ¼ãƒˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $quality_gate_exit_code"
        
        # çµæžœã®è§£æž
        if [[ -f "quality_gate_output.json" ]]; then
          # JSONå‡ºåŠ›ã‹ã‚‰çµæžœã‚’æŠ½å‡º
          if command -v jq >/dev/null 2>&1; then
            gate_status=$(tail -n 20 quality_gate_output.json | jq -r '.final_status // "UNKNOWN"' 2>/dev/null || echo "UNKNOWN")
            overall_score=$(tail -n 20 quality_gate_output.json | jq -r '.overall_score // 0' 2>/dev/null || echo "0")
            blocking_failures=$(tail -n 20 quality_gate_output.json | jq -r '.blocking_failures | length // 0' 2>/dev/null || echo "0")
            warnings=$(tail -n 20 quality_gate_output.json | jq -r '.warnings | length // 0' 2>/dev/null || echo "0")
          else
            # jqãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿å‡¦ç†
            gate_status="UNKNOWN"
            overall_score="0"
            blocking_failures="0"
            warnings="0"
            
            # ç°¡å˜ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒãƒ³ã‚°
            if grep -q '"final_status": "PASS"' quality_gate_output.json 2>/dev/null; then
              gate_status="PASS"
            elif grep -q '"final_status": "WARN"' quality_gate_output.json 2>/dev/null; then
              gate_status="WARN"
            elif grep -q '"final_status": "FAIL"' quality_gate_output.json 2>/dev/null; then
              gate_status="FAIL"
            fi
          fi
        else
          echo "âš ï¸ å“è³ªã‚²ãƒ¼ãƒˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          gate_status="UNKNOWN"
          overall_score="0"
          blocking_failures="0"
          warnings="0"
        fi
        
        # GitHub Actionså‡ºåŠ›
        echo "gate-status=$gate_status" >> $GITHUB_OUTPUT
        echo "overall-score=$overall_score" >> $GITHUB_OUTPUT
        echo "blocking-failures=$blocking_failures" >> $GITHUB_OUTPUT
        echo "warnings=$warnings" >> $GITHUB_OUTPUT
        echo "report-path=${{ inputs.output-path }}" >> $GITHUB_OUTPUT
        
        # çµæžœã‚µãƒžãƒªãƒ¼ã®è¡¨ç¤º
        echo "ðŸ“Š å“è³ªã‚²ãƒ¼ãƒˆçµæžœ:"
        echo "  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $gate_status"
        echo "  ç·åˆã‚¹ã‚³ã‚¢: $overall_score"
        echo "  ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¤±æ•—: $blocking_failures"
        echo "  è­¦å‘Š: $warnings"
        echo "  ãƒ¬ãƒãƒ¼ãƒˆ: ${{ inputs.output-path }}"
        
        # å“è³ªã‚²ãƒ¼ãƒˆã®åˆ¤å®šçµæžœã‚’ä¿å­˜
        echo "$quality_gate_exit_code" > quality_gate_exit_code.txt

    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: quality-gate-report-${{ github.run_number }}
        path: |
          ${{ inputs.output-path }}
          quality_gate_output.json
          quality_gate_exit_code.txt
        retention-days: 30

    - name: Generate GitHub summary
      if: always()
      shell: bash
      run: |
        echo "ðŸ“„ GitHub Actionsã‚µãƒžãƒªãƒ¼ã‚’ç”Ÿæˆä¸­..."
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸçµµæ–‡å­—
        case "${{ steps.evaluate-quality.outputs.gate-status }}" in
          "PASS") status_emoji="âœ…" ;;
          "WARN") status_emoji="âš ï¸" ;;
          "FAIL") status_emoji="âŒ" ;;
          *) status_emoji="â“" ;;
        esac
        
        # GitHub Actions ã‚µãƒžãƒªãƒ¼ã®ç”Ÿæˆ
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ${status_emoji} å“è³ªã‚²ãƒ¼ãƒˆçµæžœ
        
        | é …ç›® | å€¤ |
        |------|-----|
        | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ${status_emoji} ${{ steps.evaluate-quality.outputs.gate-status }} |
        | ç·åˆã‚¹ã‚³ã‚¢ | ${{ steps.evaluate-quality.outputs.overall-score }}/100 |
        | ç’°å¢ƒ | ${{ inputs.environment }} |
        | ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¤±æ•— | ${{ steps.evaluate-quality.outputs.blocking-failures }} |
        | è­¦å‘Š | ${{ steps.evaluate-quality.outputs.warnings }} |
        
        ### ðŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ
        - è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: \`${{ inputs.output-path }}\`
        - è©•ä¾¡çµæžœJSON: \`quality_gate_output.json\`
        
        $(if [[ "${{ steps.evaluate-quality.outputs.gate-status }}" == "PASS" ]]; then
          echo "ðŸŽ‰ **å“è³ªã‚²ãƒ¼ãƒˆåˆæ ¼**: å…¨ã¦ã®å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ç¶™ç¶šã§ãã¾ã™ã€‚"
        elif [[ "${{ steps.evaluate-quality.outputs.gate-status }}" == "WARN" ]]; then
          echo "âš ï¸ **å“è³ªã‚²ãƒ¼ãƒˆè­¦å‘Š**: ä¸€éƒ¨ã®æŽ¨å¥¨åŸºæº–ãŒæœªé”æˆã§ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚"
        elif [[ "${{ steps.evaluate-quality.outputs.gate-status }}" == "FAIL" ]]; then
          echo "âŒ **å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—**: é‡è¦ãªå“è³ªåŸºæº–ãŒæœªé”æˆã§ã™ã€‚å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
        else
          echo "â“ **å“è³ªã‚²ãƒ¼ãƒˆä¸æ˜Ž**: è©•ä¾¡çµæžœã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
        fi)
        EOF

    - name: Comment PR with quality gate results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const gateStatus = '${{ steps.evaluate-quality.outputs.gate-status }}';
          const overallScore = '${{ steps.evaluate-quality.outputs.overall-score }}';
          const blockingFailures = '${{ steps.evaluate-quality.outputs.blocking-failures }}';
          const warnings = '${{ steps.evaluate-quality.outputs.warnings }}';
          
          const statusEmoji = {
            'PASS': 'âœ…',
            'WARN': 'âš ï¸',
            'FAIL': 'âŒ',
            'UNKNOWN': 'â“'
          };
          
          const emoji = statusEmoji[gateStatus] || 'â“';
          
          const comment = `## ${emoji} å“è³ªã‚²ãƒ¼ãƒˆçµæžœ
          
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${emoji} ${gateStatus}
          **ç·åˆã‚¹ã‚³ã‚¢**: ${overallScore}/100
          **ç’°å¢ƒ**: ${{ inputs.environment }}
          
          **è©³ç´°**:
          - ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¤±æ•—: ${blockingFailures}
          - è­¦å‘Š: ${warnings}
          
          ${gateStatus === 'PASS' ? 
            'ðŸŽ‰ å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼' : 
            gateStatus === 'WARN' ?
            'âš ï¸ ä¸€éƒ¨ã®æŽ¨å¥¨åŸºæº–ãŒæœªé”æˆã§ã™ãŒã€ç¶™ç¶šå¯èƒ½ã§ã™ã€‚' :
            'âŒ é‡è¦ãªå“è³ªåŸºæº–ãŒæœªé”æˆã§ã™ã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚'
          }
          
          è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯Artifactsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Fail if quality gate failed
      if: inputs.fail-on-quality-gate == 'true'
      shell: bash
      run: |
        # å“è³ªã‚²ãƒ¼ãƒˆã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
        if [[ -f "quality_gate_exit_code.txt" ]]; then
          quality_gate_exit_code=$(cat quality_gate_exit_code.txt)
          
          if [[ "$quality_gate_exit_code" != "0" ]]; then
            echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.evaluate-quality.outputs.gate-status }}"
            echo "ã‚¹ã‚³ã‚¢: ${{ steps.evaluate-quality.outputs.overall-score }}/100"
            echo "ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¤±æ•—: ${{ steps.evaluate-quality.outputs.blocking-failures }}"
            exit "$quality_gate_exit_code"
          fi
        fi
        
        echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†"