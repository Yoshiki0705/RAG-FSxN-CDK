name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (quick/full)'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - full

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  # ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨äº‹å‰ãƒã‚§ãƒƒã‚¯
  setup:
    runs-on: ubuntu-latest
    outputs:
      test-mode: ${{ steps.determine-mode.outputs.test-mode }}
      should-deploy: ${{ steps.determine-mode.outputs.should-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine test mode and deployment
        id: determine-mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "test-mode=${{ github.event.inputs.test_mode }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "test-mode=full" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "test-mode=full" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "test-mode=quick" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  # ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆå…¨ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œï¼‰
  quick-tests:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          chmod +x development/scripts/testing/quick_integration_test.sh
          mkdir -p development/logs/testing

      - name: Run quick integration tests
        id: quick-tests
        run: |
          echo "ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹"
          ./development/scripts/testing/quick_integration_test.sh --mode quick --verbose > test_output.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse test results
        id: parse-results
        run: |
          if [[ -f "test_output.log" ]]; then
            # ãƒ†ã‚¹ãƒˆçµæœã®è§£æ
            total_tests=$(grep -o "ç·ãƒ†ã‚¹ãƒˆæ•°: [0-9]*" test_output.log | grep -o "[0-9]*" || echo "0")
            passed_tests=$(grep -o "æˆåŠŸ: [0-9]*" test_output.log | grep -o "[0-9]*" || echo "0")
            failed_tests=$(grep -o "å¤±æ•—: [0-9]*" test_output.log | grep -o "[0-9]*" || echo "0")
            execution_time=$(grep -o "ç·å®Ÿè¡Œæ™‚é–“: [0-9]*ms" test_output.log | grep -o "[0-9]*" || echo "0")
            
            echo "total-tests=$total_tests" >> $GITHUB_OUTPUT
            echo "passed-tests=$passed_tests" >> $GITHUB_OUTPUT
            echo "failed-tests=$failed_tests" >> $GITHUB_OUTPUT
            echo "execution-time=$execution_time" >> $GITHUB_OUTPUT
            
            # æˆåŠŸç‡è¨ˆç®—
            if [[ $total_tests -gt 0 ]]; then
              success_rate=$(echo "scale=2; $passed_tests * 100 / $total_tests" | bc -l)
              echo "success-rate=$success_rate" >> $GITHUB_OUTPUT
            else
              echo "success-rate=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "total-tests=0" >> $GITHUB_OUTPUT
            echo "passed-tests=0" >> $GITHUB_OUTPUT
            echo "failed-tests=0" >> $GITHUB_OUTPUT
            echo "execution-time=0" >> $GITHUB_OUTPUT
            echo "success-rate=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quick-test-results
          path: |
            test_output.log
            development/logs/testing/
          retention-days: 30

      - name: Comment PR with quick test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testResults = {
              total: '${{ steps.parse-results.outputs.total-tests }}',
              passed: '${{ steps.parse-results.outputs.passed-tests }}',
              failed: '${{ steps.parse-results.outputs.failed-tests }}',
              successRate: '${{ steps.parse-results.outputs.success-rate }}',
              executionTime: '${{ steps.parse-results.outputs.execution-time }}'
            };
            
            const status = testResults.failed === '0' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—';
            const comment = `## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ
            
            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${status}
            **ç·ãƒ†ã‚¹ãƒˆæ•°**: ${testResults.total}
            **æˆåŠŸ**: ${testResults.passed}
            **å¤±æ•—**: ${testResults.failed}
            **æˆåŠŸç‡**: ${testResults.successRate}%
            **å®Ÿè¡Œæ™‚é–“**: ${testResults.executionTime}ms
            
            ${testResults.failed === '0' ? 
              'ğŸ‰ å…¨ã¦ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼' : 
              'âš ï¸ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯Artifactsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            }`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail job if tests failed
        if: steps.quick-tests.outputs.exit_code != '0'
        run: |
          echo "âŒ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1

  # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆmainã¨developãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  full-tests:
    runs-on: ubuntu-latest
    needs: [setup, quick-tests]
    if: needs.setup.outputs.test-mode == 'full'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          chmod +x development/scripts/testing/quick_integration_test.sh
          mkdir -p development/logs/testing

      - name: Run full integration tests
        id: full-tests
        run: |
          echo "ğŸš€ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹"
          ./development/scripts/testing/quick_integration_test.sh --mode full --verbose > full_test_output.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse full test results
        id: parse-full-results
        run: |
          if [[ -f "full_test_output.log" ]]; then
            # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆçµæœã®è§£æ
            total_tests=$(grep -o "ç·ãƒ†ã‚¹ãƒˆæ•°: [0-9]*" full_test_output.log | grep -o "[0-9]*" || echo "0")
            passed_tests=$(grep -o "æˆåŠŸ: [0-9]*" full_test_output.log | grep -o "[0-9]*" || echo "0")
            failed_tests=$(grep -o "å¤±æ•—: [0-9]*" full_test_output.log | grep -o "[0-9]*" || echo "0")
            execution_time=$(grep -o "ç·å®Ÿè¡Œæ™‚é–“: [0-9]*ms" full_test_output.log | grep -o "[0-9]*" || echo "0")
            
            echo "total-tests=$total_tests" >> $GITHUB_OUTPUT
            echo "passed-tests=$passed_tests" >> $GITHUB_OUTPUT
            echo "failed-tests=$failed_tests" >> $GITHUB_OUTPUT
            echo "execution-time=$execution_time" >> $GITHUB_OUTPUT
            
            # æˆåŠŸç‡è¨ˆç®—
            if [[ $total_tests -gt 0 ]]; then
              success_rate=$(echo "scale=2; $passed_tests * 100 / $total_tests" | bc -l)
              echo "success-rate=$success_rate" >> $GITHUB_OUTPUT
            else
              echo "success-rate=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "total-tests=0" >> $GITHUB_OUTPUT
            echo "passed-tests=0" >> $GITHUB_OUTPUT
            echo "failed-tests=0" >> $GITHUB_OUTPUT
            echo "execution-time=0" >> $GITHUB_OUTPUT
            echo "success-rate=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload full test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: full-test-results
          path: |
            full_test_output.log
            development/logs/testing/
          retention-days: 30

      - name: Fail job if full tests failed
        if: steps.full-tests.outputs.exit_code != '0'
        run: |
          echo "âŒ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1

  # TypeScript/CDKãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation test
        run: |
          echo "ğŸ”§ TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npm run build

      - name: CDK synthesis test
        run: |
          echo "ğŸ—ï¸ CDK synthesis ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npx cdk synth --quiet

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            cdk.out/
            dist/
          retention-days: 7

  # åŸºæœ¬çš„ãªå“è³ªã‚²ãƒ¼ãƒˆ
  quality-gate:
    runs-on: ubuntu-latest
    needs: [quick-tests, full-tests, build-test]
    if: always()
    outputs:
      gate-status: ${{ steps.evaluate-quality.outputs.gate-status }}
      gate-score: ${{ steps.evaluate-quality.outputs.gate-score }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v3
        with:
          name: quick-test-results
          path: ./test-results/quick/
        continue-on-error: true

      - name: Download full test results
        uses: actions/download-artifact@v3
        with:
          name: full-test-results
          path: ./test-results/full/
        continue-on-error: true

      - name: Evaluate quality metrics
        id: evaluate-quality
        run: |
          echo "ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹è©•ä¾¡ä¸­..."
          
          # åŸºæœ¬çš„ãªå“è³ªåŸºæº–
          MIN_SUCCESS_RATE=95
          MAX_EXECUTION_TIME=30000  # 30ç§’
          
          # ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœã®å–å¾—
          quick_success_rate="${{ needs.quick-tests.outputs.success-rate || '0' }}"
          quick_execution_time="${{ needs.quick-tests.outputs.execution-time || '0' }}"
          
          # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆçµæœã®å–å¾—ï¼ˆå®Ÿè¡Œã•ã‚ŒãŸå ´åˆï¼‰
          if [[ "${{ needs.setup.outputs.test-mode }}" == "full" ]]; then
            full_success_rate="${{ needs.full-tests.outputs.success-rate || '0' }}"
            full_execution_time="${{ needs.full-tests.outputs.execution-time || '0' }}"
          else
            full_success_rate="100"
            full_execution_time="0"
          fi
          
          # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆçµæœ
          build_status="${{ needs.build-test.result }}"
          
          # å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—
          quality_score=0
          
          # ãƒ†ã‚¹ãƒˆæˆåŠŸç‡è©•ä¾¡ï¼ˆ40%ï¼‰
          if (( $(echo "$quick_success_rate >= $MIN_SUCCESS_RATE" | bc -l) )); then
            quality_score=$((quality_score + 40))
          fi
          
          # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸç‡è©•ä¾¡ï¼ˆ30%ï¼‰
          if (( $(echo "$full_success_rate >= $MIN_SUCCESS_RATE" | bc -l) )); then
            quality_score=$((quality_score + 30))
          fi
          
          # ãƒ“ãƒ«ãƒ‰æˆåŠŸè©•ä¾¡ï¼ˆ20%ï¼‰
          if [[ "$build_status" == "success" ]]; then
            quality_score=$((quality_score + 20))
          fi
          
          # å®Ÿè¡Œæ™‚é–“è©•ä¾¡ï¼ˆ10%ï¼‰
          if [[ $quick_execution_time -lt $MAX_EXECUTION_TIME ]]; then
            quality_score=$((quality_score + 10))
          fi
          
          # å“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š
          if [[ $quality_score -ge 80 ]]; then
            gate_status="PASS"
          else
            gate_status="FAIL"
          fi
          
          echo "gate-status=$gate_status" >> $GITHUB_OUTPUT
          echo "gate-score=$quality_score" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š å“è³ªè©•ä¾¡çµæœ:"
          echo "  - ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸç‡: $quick_success_rate%"
          echo "  - ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸç‡: $full_success_rate%"
          echo "  - ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $build_status"
          echo "  - å“è³ªã‚¹ã‚³ã‚¢: $quality_score/100"
          echo "  - å“è³ªã‚²ãƒ¼ãƒˆ: $gate_status"

      - name: Create quality report
        run: |
          cat > quality-report.md << EOF
          # å“è³ªãƒ¬ãƒãƒ¼ãƒˆ
          
          ## ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
          
          | é …ç›® | å€¤ | åŸºæº– | çŠ¶æ…‹ |
          |------|----|----|------|
          | ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ | ${{ needs.quick-tests.outputs.success-rate || '0' }}% | â‰¥95% | ${{ (needs.quick-tests.outputs.success-rate >= '95') && 'âœ…' || 'âŒ' }} |
          | ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ | ${{ needs.full-tests.outputs.success-rate || 'N/A' }}% | â‰¥95% | ${{ (needs.full-tests.outputs.success-rate >= '95') && 'âœ…' || 'âŒ' }} |
          | ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ${{ needs.build-test.result }} | success | ${{ (needs.build-test.result == 'success') && 'âœ…' || 'âŒ' }} |
          | å“è³ªã‚¹ã‚³ã‚¢ | ${{ steps.evaluate-quality.outputs.gate-score }}/100 | â‰¥80 | ${{ (steps.evaluate-quality.outputs.gate-score >= '80') && 'âœ…' || 'âŒ' }} |
          
          ## ğŸ¯ å“è³ªã‚²ãƒ¼ãƒˆçµæœ
          
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.evaluate-quality.outputs.gate-status == 'PASS' && 'âœ… åˆæ ¼' || 'âŒ ä¸åˆæ ¼' }}
          
          ${{ steps.evaluate-quality.outputs.gate-status == 'PASS' && 'ğŸ‰ å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ç¶™ç¶šã§ãã¾ã™ã€‚' || 'âš ï¸ å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚' }}
          EOF

      - name: Upload quality report
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: quality-report.md
          retention-days: 30

      - name: Fail if quality gate failed
        if: steps.evaluate-quality.outputs.gate-status == 'FAIL'
        run: |
          echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "å“è³ªã‚¹ã‚³ã‚¢: ${{ steps.evaluate-quality.outputs.gate-score }}/100"
          exit 1

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify:
    runs-on: ubuntu-latest
    needs: [setup, quick-tests, full-tests, build-test, quality-gate]
    if: always()
    steps:
      - name: Determine overall status
        id: overall-status
        run: |
          # å…¨ä½“çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š
          quick_status="${{ needs.quick-tests.result }}"
          full_status="${{ needs.full-tests.result }}"
          build_status="${{ needs.build-test.result }}"
          quality_status="${{ needs.quality-gate.result }}"
          
          if [[ "$quick_status" == "success" && "$build_status" == "success" && "$quality_status" == "success" ]]; then
            if [[ "${{ needs.setup.outputs.test-mode }}" == "full" ]]; then
              if [[ "$full_status" == "success" ]]; then
                overall_status="success"
              else
                overall_status="failure"
              fi
            else
              overall_status="success"
            fi
          else
            overall_status="failure"
          fi
          
          echo "overall-status=$overall_status" >> $GITHUB_OUTPUT

      - name: Create notification message
        id: create-message
        run: |
          # é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
          if [[ "${{ steps.overall-status.outputs.overall-status }}" == "success" ]]; then
            status_emoji="âœ…"
            status_text="æˆåŠŸ"
            color="good"
          else
            status_emoji="âŒ"
            status_text="å¤±æ•—"
            color="danger"
          fi
          
          message="$status_emoji CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ $status_text
          
          **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
          **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          **å®Ÿè¡Œè€…**: ${{ github.actor }}
          **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ needs.setup.outputs.test-mode }}
          
          **çµæœã‚µãƒãƒªãƒ¼**:
          - ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ: ${{ needs.quick-tests.result }}
          - ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆ: ${{ needs.full-tests.result || 'ã‚¹ã‚­ãƒƒãƒ—' }}
          - ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ: ${{ needs.build-test.result }}
          - å“è³ªã‚²ãƒ¼ãƒˆ: ${{ needs.quality-gate.result }}
          
          **å“è³ªã‚¹ã‚³ã‚¢**: ${{ needs.quality-gate.outputs.gate-score || '0' }}/100"
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$message" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "color=$color" >> $GITHUB_OUTPUT

      - name: Notify to console
        run: |
          echo "ğŸ“¢ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é€šçŸ¥"
          echo "${{ steps.create-message.outputs.message }}"

      # å°†æ¥çš„ã«Slacké€šçŸ¥ã‚’è¿½åŠ äºˆå®š
      # - name: Notify Slack
      #   if: env.SLACK_WEBHOOK_URL != ''
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ steps.overall-status.outputs.overall-status }}
      #     text: ${{ steps.create-message.outputs.message }}
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}