name: Pull Request Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  # PRæƒ…å ±ã®å–å¾—ã¨åˆ†æ
  pr-analysis:
    runs-on: ubuntu-latest
    outputs:
      files-changed: ${{ steps.changed-files.outputs.files-changed }}
      has-code-changes: ${{ steps.analyze-changes.outputs.has-code-changes }}
      has-test-changes: ${{ steps.analyze-changes.outputs.has-test-changes }}
      has-config-changes: ${{ steps.analyze-changes.outputs.has-config-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > changed_files.txt
          files_changed=$(cat changed_files.txt | wc -l)
          echo "files-changed=$files_changed" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: $files_changed"
          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          cat changed_files.txt

      - name: Analyze change types
        id: analyze-changes
        run: |
          # å¤‰æ›´ã®ç¨®é¡ã‚’åˆ†æ
          has_code_changes=false
          has_test_changes=false
          has_config_changes=false
          
          while IFS= read -r file; do
            case "$file" in
              *.ts|*.js|*.tsx|*.jsx|*.py)
                if [[ "$file" == *test* || "$file" == *spec* ]]; then
                  has_test_changes=true
                else
                  has_code_changes=true
                fi
                ;;
              *.json|*.yml|*.yaml|*.toml|*.ini)
                has_config_changes=true
                ;;
              development/scripts/*)
                has_code_changes=true
                ;;
            esac
          done < changed_files.txt
          
          echo "has-code-changes=$has_code_changes" >> $GITHUB_OUTPUT
          echo "has-test-changes=$has_test_changes" >> $GITHUB_OUTPUT
          echo "has-config-changes=$has_config_changes" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š å¤‰æ›´åˆ†æçµæœ:"
          echo "  - ã‚³ãƒ¼ãƒ‰å¤‰æ›´: $has_code_changes"
          echo "  - ãƒ†ã‚¹ãƒˆå¤‰æ›´: $has_test_changes"
          echo "  - è¨­å®šå¤‰æ›´: $has_config_changes"

  # è»½é‡ãªPRãƒã‚§ãƒƒã‚¯
  pr-quick-check:
    runs-on: ubuntu-latest
    needs: pr-analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        if: needs.pr-analysis.outputs.has-code-changes == 'true'
        run: |
          echo "ğŸ” Lintãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          npm run lint || echo "Lint warnings found"

      - name: TypeScript type check
        if: needs.pr-analysis.outputs.has-code-changes == 'true'
        run: |
          echo "ğŸ”§ TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          npx tsc --noEmit

      - name: Quick build test
        if: needs.pr-analysis.outputs.has-code-changes == 'true'
        run: |
          echo "ğŸ—ï¸ ã‚¯ã‚¤ãƒƒã‚¯ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npm run build

      - name: CDK diff check
        if: needs.pr-analysis.outputs.has-code-changes == 'true'
        run: |
          echo "ğŸ“‹ CDKå·®åˆ†ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          npx cdk diff --quiet || echo "CDK changes detected"

  # PRã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
  pr-size-check:
    runs-on: ubuntu-latest
    needs: pr-analysis
    steps:
      - name: Check PR size
        run: |
          files_changed=${{ needs.pr-analysis.outputs.files-changed }}
          
          echo "ğŸ“ PRã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯"
          echo "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $files_changed"
          
          if [[ $files_changed -gt 50 ]]; then
            echo "âš ï¸ å¤§ããªPRã§ã™ ($files_changed ãƒ•ã‚¡ã‚¤ãƒ«)"
            echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã€PRã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
            # è­¦å‘Šã®ã¿ã§å¤±æ•—ã•ã›ãªã„
          elif [[ $files_changed -gt 20 ]]; then
            echo "ğŸ“‹ ä¸­è¦æ¨¡ã®PRã§ã™ ($files_changed ãƒ•ã‚¡ã‚¤ãƒ«)"
            echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚é–“ã‚’ååˆ†ã«ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚"
          else
            echo "âœ… é©åˆ‡ãªã‚µã‚¤ã‚ºã®PRã§ã™ ($files_changed ãƒ•ã‚¡ã‚¤ãƒ«)"
          fi

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security-check:
    runs-on: ubuntu-latest
    needs: pr-analysis
    if: needs.pr-analysis.outputs.has-code-changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œä¸­..."
          npm audit --audit-level=moderate || echo "Security vulnerabilities found"

      - name: Check for secrets
        run: |
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          
          # åŸºæœ¬çš„ãªæ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          secret_patterns=(
            "password.*=.*['\"][^'\"]*['\"]"
            "api[_-]?key.*=.*['\"][^'\"]*['\"]"
            "secret.*=.*['\"][^'\"]*['\"]"
            "token.*=.*['\"][^'\"]*['\"]"
            "AKIA[0-9A-Z]{16}"
            "-----BEGIN.*PRIVATE KEY-----"
          )
          
          found_secrets=false
          for pattern in "${secret_patterns[@]}"; do
            if git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -iE "$pattern"; then
              echo "âš ï¸ æ©Ÿå¯†æƒ…å ±ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $pattern"
              found_secrets=true
            fi
          done
          
          if [[ "$found_secrets" == "true" ]]; then
            echo "âŒ æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          else
            echo "âœ… æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯å®Œäº†"
          fi

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
  pr-tests:
    runs-on: ubuntu-latest
    needs: [pr-analysis, pr-quick-check]
    if: needs.pr-analysis.outputs.has-code-changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          chmod +x development/scripts/testing/quick_integration_test.sh
          mkdir -p development/logs/testing

      - name: Run integration tests
        id: pr-tests
        run: |
          echo "ğŸ§ª PRçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          ./development/scripts/testing/quick_integration_test.sh --mode quick --verbose > pr_test_output.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse test results
        id: parse-results
        run: |
          if [[ -f "pr_test_output.log" ]]; then
            total_tests=$(grep -o "ç·ãƒ†ã‚¹ãƒˆæ•°: [0-9]*" pr_test_output.log | grep -o "[0-9]*" || echo "0")
            passed_tests=$(grep -o "æˆåŠŸ: [0-9]*" pr_test_output.log | grep -o "[0-9]*" || echo "0")
            failed_tests=$(grep -o "å¤±æ•—: [0-9]*" pr_test_output.log | grep -o "[0-9]*" || echo "0")
            execution_time=$(grep -o "ç·å®Ÿè¡Œæ™‚é–“: [0-9]*ms" pr_test_output.log | grep -o "[0-9]*" || echo "0")
            
            echo "total-tests=$total_tests" >> $GITHUB_OUTPUT
            echo "passed-tests=$passed_tests" >> $GITHUB_OUTPUT
            echo "failed-tests=$failed_tests" >> $GITHUB_OUTPUT
            echo "execution-time=$execution_time" >> $GITHUB_OUTPUT
            
            if [[ $total_tests -gt 0 ]]; then
              success_rate=$(echo "scale=2; $passed_tests * 100 / $total_tests" | bc -l)
              echo "success-rate=$success_rate" >> $GITHUB_OUTPUT
            else
              echo "success-rate=0" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload PR test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: pr-test-results
          path: |
            pr_test_output.log
            development/logs/testing/
          retention-days: 14

      - name: Fail if tests failed
        if: steps.pr-tests.outputs.exit_code != '0'
        run: |
          echo "âŒ PRãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1

  # PRçµæœã‚µãƒãƒªãƒ¼
  pr-summary:
    runs-on: ubuntu-latest
    needs: [pr-analysis, pr-quick-check, security-check, pr-tests]
    if: always()
    steps:
      - name: Create PR summary
        uses: actions/github-script@v7
        with:
          script: |
            const prAnalysis = ${{ toJson(needs.pr-analysis) }};
            const quickCheck = ${{ toJson(needs.pr-quick-check) }};
            const securityCheck = ${{ toJson(needs.security-check) }};
            const prTests = ${{ toJson(needs.pr-tests) }};
            
            // å…¨ä½“çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
            const allSuccess = [quickCheck, securityCheck, prTests]
              .filter(job => job.result !== 'skipped')
              .every(job => job.result === 'success');
            
            const statusEmoji = allSuccess ? 'âœ…' : 'âŒ';
            const statusText = allSuccess ? 'åˆæ ¼' : 'è¦ä¿®æ­£';
            
            // ãƒ†ã‚¹ãƒˆçµæœã®å–å¾—
            const testResults = prTests.outputs || {};
            
            const summary = `## ğŸ” PR ãƒã‚§ãƒƒã‚¯çµæœ: ${statusEmoji} ${statusText}
            
            ### ğŸ“Š å¤‰æ›´ã‚µãƒãƒªãƒ¼
            - **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${prAnalysis.outputs['files-changed'] || '0'}
            - **ã‚³ãƒ¼ãƒ‰å¤‰æ›´**: ${prAnalysis.outputs['has-code-changes'] === 'true' ? 'âœ…' : 'âŒ'}
            - **ãƒ†ã‚¹ãƒˆå¤‰æ›´**: ${prAnalysis.outputs['has-test-changes'] === 'true' ? 'âœ…' : 'âŒ'}
            - **è¨­å®šå¤‰æ›´**: ${prAnalysis.outputs['has-config-changes'] === 'true' ? 'âœ…' : 'âŒ'}
            
            ### ğŸ§ª ãƒã‚§ãƒƒã‚¯çµæœ
            | ãƒã‚§ãƒƒã‚¯é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |
            |-------------|-----------|------|
            | ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ | ${quickCheck.result === 'success' ? 'âœ… åˆæ ¼' : quickCheck.result === 'skipped' ? 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' : 'âŒ å¤±æ•—'} | Lint, TypeScript, Build |
            | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ | ${securityCheck.result === 'success' ? 'âœ… åˆæ ¼' : securityCheck.result === 'skipped' ? 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' : 'âŒ å¤±æ•—'} | è„†å¼±æ€§, æ©Ÿå¯†æƒ…å ± |
            | çµ±åˆãƒ†ã‚¹ãƒˆ | ${prTests.result === 'success' ? 'âœ… åˆæ ¼' : prTests.result === 'skipped' ? 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' : 'âŒ å¤±æ•—'} | ${testResults['total-tests'] || '0'}å€‹ã®ãƒ†ã‚¹ãƒˆ |
            
            ${testResults['total-tests'] ? `
            ### ğŸ“ˆ ãƒ†ã‚¹ãƒˆè©³ç´°
            - **ç·ãƒ†ã‚¹ãƒˆæ•°**: ${testResults['total-tests']}
            - **æˆåŠŸ**: ${testResults['passed-tests']}
            - **å¤±æ•—**: ${testResults['failed-tests']}
            - **æˆåŠŸç‡**: ${testResults['success-rate']}%
            - **å®Ÿè¡Œæ™‚é–“**: ${testResults['execution-time']}ms
            ` : ''}
            
            ### ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            ${allSuccess ? 
              'ğŸ‰ å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼' : 
              'âš ï¸ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯ãƒã‚§ãƒƒã‚¯çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            }
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR ãƒã‚§ãƒƒã‚¯çµæœ')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }