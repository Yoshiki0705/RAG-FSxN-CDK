name: CI/CD Pipeline with Slack Notifications
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PROJECT_NAME: permission-aware-rag-system
  NODE_VERSION: '20'

jobs:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    outputs:
      test-results: ${{ steps.test-execution.outputs.results }}
      test-success: ${{ steps.test-execution.outputs.success }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          chmod +x development/scripts/testing/quick_integration_test.sh
      
      - name: Run integration tests
        id: test-execution
        run: |
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          if ./development/scripts/testing/quick_integration_test.sh --mode quick --output-format json; then
            echo "success=true" >> $GITHUB_OUTPUT
            TEST_RESULTS=$(cat development/logs/testing/test-results.json 2>/dev/null || echo '{}')
          else
            echo "success=false" >> $GITHUB_OUTPUT
            TEST_RESULTS='{"success_rate": 0, "total_tests": 0, "passed_tests": 0, "failed_tests": 1, "duration": 0}'
          fi
          
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$TEST_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: development/logs/testing/
      
      # ãƒ†ã‚¹ãƒˆçµæœã®Slacké€šçŸ¥
      - name: Notify test results
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          type: 'test'
          data: ${{ steps.test-execution.outputs.results }}
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#ci-cd'

  # å“è³ªã‚²ãƒ¼ãƒˆã‚¸ãƒ§ãƒ–
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: test
    if: always()
    outputs:
      quality-passed: ${{ steps.quality-check.outputs.passed }}
      quality-results: ${{ steps.quality-check.outputs.results }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Run quality gate
        id: quality-check
        run: |
          # å“è³ªã‚²ãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆä»®å®Ÿè£…ï¼‰
          TEST_RESULTS='${{ needs.test.outputs.test-results }}'
          SUCCESS_RATE=$(echo "$TEST_RESULTS" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('success_rate', 0))")
          
          if (( $(echo "$SUCCESS_RATE >= 0.95" | bc -l) )); then
            echo "passed=true" >> $GITHUB_OUTPUT
            QUALITY_RESULTS='{"passed": true, "overall_score": '$SUCCESS_RATE', "criteria": {"test_success_rate": {"score": '$SUCCESS_RATE', "threshold": 0.95}}}'
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            QUALITY_RESULTS='{"passed": false, "overall_score": '$SUCCESS_RATE', "criteria": {"test_success_rate": {"score": '$SUCCESS_RATE', "threshold": 0.95}}}'
          fi
          
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$QUALITY_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # å“è³ªã‚²ãƒ¼ãƒˆçµæœã®Slacké€šçŸ¥
      - name: Notify quality gate results
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          type: 'quality'
          data: ${{ steps.quality-check.outputs.results }}
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#ci-cd'

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [test, quality-gate]
    if: github.ref == 'refs/heads/develop' && needs.quality-gate.outputs.quality-passed == 'true'
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹é€šçŸ¥
      - name: Notify deployment start
        uses: ./.github/actions/slack-notify
        with:
          type: 'deploy'
          data: |
            {
              "status": "started",
              "environment": "development",
              "details": {
                "commit_hash": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}"
              }
            }
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#dev-updates'
      
      - name: Deploy to development
        id: deploy
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ï¼ˆä»®å®Ÿè£…ï¼‰
          echo "ğŸš€ é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œä¸­..."
          sleep 10
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "success=true" >> $GITHUB_OUTPUT
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
      - name: Notify deployment result
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          type: 'deploy'
          data: |
            {
              "status": "${{ steps.deploy.outcome == 'success' && 'success' || 'failed' }}",
              "environment": "development",
              "details": {
                "commit_hash": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}",
                "duration": 10
              }
            }
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#dev-updates'

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, quality-gate]
    if: github.ref == 'refs/heads/main' && needs.quality-gate.outputs.quality-passed == 'true'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹é€šçŸ¥ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
      - name: Notify production deployment start
        uses: ./.github/actions/slack-notify
        with:
          type: 'deploy'
          data: |
            {
              "status": "started",
              "environment": "production",
              "details": {
                "commit_hash": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}"
              }
            }
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#production-alerts'
      
      - name: Deploy to production
        id: deploy-prod
        run: |
          # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ï¼ˆä»®å®Ÿè£…ï¼‰
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œä¸­..."
          sleep 15
          echo "âœ… æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "success=true" >> $GITHUB_OUTPUT
      
      # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
      - name: Notify production deployment result
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          type: 'deploy'
          data: |
            {
              "status": "${{ steps.deploy-prod.outcome == 'success' && 'success' || 'failed' }}",
              "environment": "production",
              "details": {
                "commit_hash": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}",
                "duration": 15
              }
            }
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#production-alerts'

  # ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚¸ãƒ§ãƒ–
  error-notification:
    name: Error Notification
    runs-on: ubuntu-latest
    needs: [test, quality-gate, deploy-dev, deploy-prod]
    if: always() && (needs.test.result == 'failure' || needs.quality-gate.result == 'failure' || needs.deploy-dev.result == 'failure' || needs.deploy-prod.result == 'failure')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Send error notification
        uses: ./.github/actions/slack-notify
        with:
          type: 'error'
          data: |
            {
              "error_type": "CI/CD Pipeline Failure",
              "error_details": "ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯GitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
              "context": {
                "environment": "${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}",
                "branch": "${{ github.ref_name }}",
                "commit": "${{ github.sha }}",
                "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#alerts'