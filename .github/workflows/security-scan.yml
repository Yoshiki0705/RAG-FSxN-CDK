name: Security Scan

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Security scan type'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - deep
      notification_level:
        description: 'Notification level'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - detailed

# ç’°å¢ƒå¤‰æ•°
env:
  SCAN_TYPE: ${{ github.event.inputs.scan_type || 'full' }}
  NOTIFICATION_LEVEL: ${{ github.event.inputs.notification_level || 'normal' }}

jobs:
  # é™çš„ã‚³ãƒ¼ãƒ‰è§£æ
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      vulnerabilities-found: ${{ steps.analyze.outputs.vulnerabilities-found }}
      security-score: ${{ steps.analyze.outputs.security-score }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint security scan
        id: eslint-security
        run: |
          echo "ğŸ” ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ESLintãƒ«ãƒ¼ãƒ«å®Ÿè¡Œ
          npx eslint . --ext .ts,.js --format json --output-file eslint-security-results.json || true
          
          # çµæœè§£æ
          if [[ -f "eslint-security-results.json" ]]; then
            ESLINT_ISSUES=$(jq length eslint-security-results.json 2>/dev/null || echo "0")
            echo "ESLint issues found: $ESLINT_ISSUES"
            echo "eslint-issues=$ESLINT_ISSUES" >> $GITHUB_OUTPUT
          else
            echo "eslint-issues=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Run npm audit
        id: npm-audit
        run: |
          echo "ğŸ” npm audit ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."
          
          # npm auditã®å®Ÿè¡Œ
          set +e
          npm audit --audit-level high --json > npm-audit-results.json 2>&1
          AUDIT_EXIT_CODE=$?
          set -e
          
          # çµæœè§£æ
          if [[ -f "npm-audit-results.json" ]]; then
            if command -v jq >/dev/null 2>&1; then
              HIGH_VULNS=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
              CRITICAL_VULNS=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
              TOTAL_VULNS=$((HIGH_VULNS + CRITICAL_VULNS))
            else
              TOTAL_VULNS=$(grep -o '"high":[0-9]*' npm-audit-results.json | cut -d':' -f2 || echo "0")
            fi
          else
            TOTAL_VULNS=0
          fi
          
          echo "High/Critical vulnerabilities found: $TOTAL_VULNS"
          echo "npm-vulnerabilities=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "audit-exit-code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT
      
      - name: Run TypeScript security analysis
        id: typescript-security
        run: |
          echo "ğŸ” TypeScript ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æå®Ÿè¡Œä¸­..."
          
          # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ã®å‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
          if npx tsc --noEmit --strict; then
            echo "TypeScript security check: PASSED"
            echo "typescript-security=passed" >> $GITHUB_OUTPUT
          else
            echo "TypeScript security check: FAILED"
            echo "typescript-security=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze security results
        id: analyze
        run: |
          echo "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœã®è©•ä¾¡ä¸­..."
          
          # å„ã‚¹ã‚­ãƒ£ãƒ³çµæœã®å–å¾—
          ESLINT_ISSUES="${{ steps.eslint-security.outputs.eslint-issues }}"
          NPM_VULNS="${{ steps.npm-audit.outputs.npm-vulnerabilities }}"
          TS_SECURITY="${{ steps.typescript-security.outputs.typescript-security }}"
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢è¨ˆç®—
          SECURITY_SCORE=100
          
          # ESLintå•é¡Œã«ã‚ˆã‚‹æ¸›ç‚¹
          if [[ $ESLINT_ISSUES -gt 0 ]]; then
            SECURITY_SCORE=$((SECURITY_SCORE - ESLINT_ISSUES * 5))
          fi
          
          # npmè„†å¼±æ€§ã«ã‚ˆã‚‹æ¸›ç‚¹
          if [[ $NPM_VULNS -gt 0 ]]; then
            SECURITY_SCORE=$((SECURITY_SCORE - NPM_VULNS * 20))
          fi
          
          # TypeScriptå‹å®‰å…¨æ€§ã«ã‚ˆã‚‹æ¸›ç‚¹
          if [[ "$TS_SECURITY" == "failed" ]]; then
            SECURITY_SCORE=$((SECURITY_SCORE - 30))
          fi
          
          # æœ€å°å€¤0ã«åˆ¶é™
          if [[ $SECURITY_SCORE -lt 0 ]]; then
            SECURITY_SCORE=0
          fi
          
          # è„†å¼±æ€§åˆ¤å®š
          TOTAL_VULNERABILITIES=$((ESLINT_ISSUES + NPM_VULNS))
          if [[ "$TS_SECURITY" == "failed" ]]; then
            TOTAL_VULNERABILITIES=$((TOTAL_VULNERABILITIES + 1))
          fi
          
          VULNERABILITIES_FOUND=$([ $TOTAL_VULNERABILITIES -gt 0 ] && echo "true" || echo "false")
          
          echo "vulnerabilities-found=$VULNERABILITIES_FOUND" >> $GITHUB_OUTPUT
          echo "security-score=$SECURITY_SCORE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ:"
          echo "  ESLintå•é¡Œ: $ESLINT_ISSUES"
          echo "  npmè„†å¼±æ€§: $NPM_VULNS"
          echo "  TypeScriptå®‰å…¨æ€§: $TS_SECURITY"
          echo "  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: $SECURITY_SCORE/100"
          echo "  è„†å¼±æ€§æ¤œå‡º: $VULNERABILITIES_FOUND"
      
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-${{ github.run_number }}
          path: |
            eslint-security-results.json
            npm-audit-results.json
          retention-days: 30

  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      dependency-vulnerabilities: ${{ steps.scan-deps.outputs.dependency-vulnerabilities }}
      scan-status: ${{ steps.scan-deps.outputs.scan-status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run dependency vulnerability scan
        id: scan-deps
        run: |
          echo "ğŸ” ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."
          
          # npm auditã®è©³ç´°å®Ÿè¡Œ
          set +e
          npm audit --json > dependency-audit.json 2>&1
          AUDIT_EXIT_CODE=$?
          set -e
          
          # çµæœè§£æ
          if [[ -f "dependency-audit.json" ]] && command -v jq >/dev/null 2>&1; then
            CRITICAL_VULNS=$(jq -r '.metadata.vulnerabilities.critical // 0' dependency-audit.json)
            HIGH_VULNS=$(jq -r '.metadata.vulnerabilities.high // 0' dependency-audit.json)
            MODERATE_VULNS=$(jq -r '.metadata.vulnerabilities.moderate // 0' dependency-audit.json)
            LOW_VULNS=$(jq -r '.metadata.vulnerabilities.low // 0' dependency-audit.json)
            
            TOTAL_VULNS=$((CRITICAL_VULNS + HIGH_VULNS + MODERATE_VULNS + LOW_VULNS))
          else
            CRITICAL_VULNS=0
            HIGH_VULNS=0
            MODERATE_VULNS=0
            LOW_VULNS=0
            TOTAL_VULNS=0
          fi
          
          # ã‚¹ã‚­ãƒ£ãƒ³çŠ¶æ…‹åˆ¤å®š
          if [[ $CRITICAL_VULNS -gt 0 ]]; then
            SCAN_STATUS="critical"
          elif [[ $HIGH_VULNS -gt 0 ]]; then
            SCAN_STATUS="high"
          elif [[ $MODERATE_VULNS -gt 0 ]]; then
            SCAN_STATUS="moderate"
          elif [[ $LOW_VULNS -gt 0 ]]; then
            SCAN_STATUS="low"
          else
            SCAN_STATUS="clean"
          fi
          
          echo "dependency-vulnerabilities=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "scan-status=$SCAN_STATUS" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœ:"
          echo "  Critical: $CRITICAL_VULNS"
          echo "  High: $HIGH_VULNS"
          echo "  Moderate: $MODERATE_VULNS"
          echo "  Low: $LOW_VULNS"
          echo "  Total: $TOTAL_VULNS"
          echo "  Status: $SCAN_STATUS"
      
      - name: Upload dependency scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results-${{ github.run_number }}
          path: |
            dependency-audit.json
          retention-days: 30

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆè©•ä¾¡
  security-gate:
    name: Security Gate Evaluation
    runs-on: ubuntu-latest
    needs: [static-analysis, dependency-scan]
    if: always()
    
    outputs:
      security-gate-status: ${{ steps.evaluate.outputs.security-gate-status }}
      overall-security-score: ${{ steps.evaluate.outputs.overall-security-score }}
    
    steps:
      - name: Evaluate security gate
        id: evaluate
        run: |
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆè©•ä¾¡å®Ÿè¡Œä¸­..."
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµæœã®å–å¾—
          VULNERABILITIES_FOUND="${{ needs.static-analysis.outputs.vulnerabilities-found }}"
          SECURITY_SCORE="${{ needs.static-analysis.outputs.security-score }}"
          DEPENDENCY_VULNS="${{ needs.dependency-scan.outputs.dependency-vulnerabilities }}"
          DEPENDENCY_STATUS="${{ needs.dependency-scan.outputs.scan-status }}"
          
          # ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢è¨ˆç®—
          OVERALL_SCORE=$SECURITY_SCORE
          
          # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã«ã‚ˆã‚‹æ¸›ç‚¹
          case "$DEPENDENCY_STATUS" in
            "critical") OVERALL_SCORE=$((OVERALL_SCORE - 50)) ;;
            "high") OVERALL_SCORE=$((OVERALL_SCORE - 30)) ;;
            "moderate") OVERALL_SCORE=$((OVERALL_SCORE - 15)) ;;
            "low") OVERALL_SCORE=$((OVERALL_SCORE - 5)) ;;
          esac
          
          # æœ€å°å€¤0ã«åˆ¶é™
          if [[ $OVERALL_SCORE -lt 0 ]]; then
            OVERALL_SCORE=0
          fi
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆåˆ¤å®š
          if [[ $OVERALL_SCORE -ge 80 && "$DEPENDENCY_STATUS" != "critical" ]]; then
            GATE_STATUS="PASS"
          else
            GATE_STATUS="FAIL"
          fi
          
          echo "security-gate-status=$GATE_STATUS" >> $GITHUB_OUTPUT
          echo "overall-security-score=$OVERALL_SCORE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆè©•ä¾¡çµæœ:"
          echo "  é™çš„è§£æã‚¹ã‚³ã‚¢: $SECURITY_SCORE/100"
          echo "  ä¾å­˜é–¢ä¿‚çŠ¶æ…‹: $DEPENDENCY_STATUS"
          echo "  ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: $OVERALL_SCORE/100"
          echo "  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ: $GATE_STATUS"
      
      - name: Create security report
        run: |
          cat > security-report.md << EOF
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ
          
          ## ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡çµæœ
          
          | é …ç›® | çµæœ | çŠ¶æ…‹ |
          |------|------|------|
          | é™çš„ã‚³ãƒ¼ãƒ‰è§£æ | ${{ needs.static-analysis.outputs.security-score }}/100 | ${{ needs.static-analysis.outputs.vulnerabilities-found == 'false' && 'âœ… å®‰å…¨' || 'âš ï¸ è¦ç¢ºèª' }} |
          | ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ | ${{ needs.dependency-scan.outputs.dependency-vulnerabilities }} ä»¶ | ${{ needs.dependency-scan.outputs.scan-status == 'clean' && 'âœ… å®‰å…¨' || 'âš ï¸ è¦å¯¾å¿œ' }} |
          | ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢ | ${{ steps.evaluate.outputs.overall-security-score }}/100 | ${{ steps.evaluate.outputs.security-gate-status == 'PASS' && 'âœ… åˆæ ¼' || 'âŒ ä¸åˆæ ¼' }} |
          
          ## ğŸ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆçµæœ
          
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.evaluate.outputs.security-gate-status == 'PASS' && 'âœ… åˆæ ¼' || 'âŒ ä¸åˆæ ¼' }}
          
          ${{ steps.evaluate.outputs.security-gate-status == 'PASS' && 'ğŸ‰ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚' || 'âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚' }}
          
          ## ğŸ“‹ æ¨å¥¨äº‹é …
          
          ${{ needs.dependency-scan.outputs.scan-status == 'critical' && 'ğŸš¨ **ç·Šæ€¥**: Criticalè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å³åº§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚' || '' }}
          ${{ needs.dependency-scan.outputs.scan-status == 'high' && 'âš ï¸ **é‡è¦**: Highè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ—©æ€¥ãªå¯¾å¿œã‚’æ¨å¥¨ã—ã¾ã™ã€‚' || '' }}
          ${{ needs.static-analysis.outputs.vulnerabilities-found == 'true' && 'ğŸ” **ç¢ºèª**: é™çš„è§£æã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' || '' }}
          ${{ steps.evaluate.outputs.security-gate-status == 'PASS' && 'âœ… **ç¶­æŒ**: ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚' || '' }}
          EOF
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: |
            security-report.md
            eslint-security-results.json
            npm-audit-results.json
          retention-days: 30
      
      - name: Comment PR with security results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const gateStatus = '${{ steps.evaluate.outputs.security-gate-status }}';
            const securityScore = '${{ steps.evaluate.outputs.overall-security-score }}';
            const dependencyVulns = '${{ needs.dependency-scan.outputs.dependency-vulnerabilities }}';
            
            const emoji = gateStatus === 'PASS' ? 'âœ…' : 'âŒ';
            const status = gateStatus === 'PASS' ? 'åˆæ ¼' : 'ä¸åˆæ ¼';
            
            const comment = `## ${emoji} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ
            
            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${status}  
            **ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢**: ${securityScore}/100  
            **ä¾å­˜é–¢ä¿‚è„†å¼±æ€§**: ${dependencyVulns} ä»¶  
            **ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ã‚¤ãƒ—**: ${{ env.SCAN_TYPE }}  
            
            ${gateStatus === 'PASS' ? 
              'ğŸ‰ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼' : 
              'âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯Artifactsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}
            
            **è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ**: [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Fail if security gate failed
        if: steps.evaluate.outputs.security-gate-status == 'FAIL'
        run: |
          echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: ${{ steps.evaluate.outputs.overall-security-score }}/100"
          echo "ä¾å­˜é–¢ä¿‚è„†å¼±æ€§: ${{ needs.dependency-scan.outputs.dependency-vulnerabilities }} ä»¶"
          exit 1

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥
  security-notification:
    name: Security Notification
    runs-on: ubuntu-latest
    needs: [static-analysis, dependency-scan, security-gate]
    if: always() && (needs.security-gate.outputs.security-gate-status == 'FAIL' || github.event.inputs.notification_level == 'detailed')
    
    steps:
      - name: Prepare security notification
        id: prepare
        run: |
          GATE_STATUS="${{ needs.security-gate.outputs.security-gate-status }}"
          SECURITY_SCORE="${{ needs.security-gate.outputs.overall-security-score }}"
          DEPENDENCY_VULNS="${{ needs.dependency-scan.outputs.dependency-vulnerabilities }}"
          
          if [[ "$GATE_STATUS" == "FAIL" ]]; then
            NOTIFICATION_TITLE="ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ: è„†å¼±æ€§æ¤œå‡º"
            NOTIFICATION_COLOR="danger"
            URGENCY="HIGH"
          else
            NOTIFICATION_TITLE="ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
            NOTIFICATION_COLOR="good"
            URGENCY="INFO"
          fi
          
          NOTIFICATION_BODY="**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ**: $GATE_STATUS
          **ç·åˆã‚¹ã‚³ã‚¢**: $SECURITY_SCORE/100
          **ä¾å­˜é–¢ä¿‚è„†å¼±æ€§**: $DEPENDENCY_VULNS ä»¶
          **å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y/%m/%d %H:%M:%S UTC')
          **ç·Šæ€¥åº¦**: $URGENCY
          
          **è©³ç´°**: [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          echo "notification-title<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTIFICATION_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "notification-body<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTIFICATION_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create security summary
        run: |
          echo "## ${{ steps.prepare.outputs.notification-title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.prepare.outputs.notification-body }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š è©³ç´°çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- **é™çš„è§£æ**: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³**: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ**: ${{ needs.security-gate.result }}" >> $GITHUB_STEP_SUMMARY
      
      # å°†æ¥çš„ã«Slacké€šçŸ¥ã‚’å®Ÿè£…
      # - name: Send security alert to Slack
      #   if: env.SLACK_WEBHOOK_URL != ''
      #   run: |
      #     python3 development/scripts/notifications/slack-notifier.py \
      #       --webhook-url "$SLACK_WEBHOOK_URL" \
      #       --type alert \
      #       --data '{"alert_level": "${{ needs.security-gate.outputs.security-gate-status == 'FAIL' && 'high' || 'low' }}", "security_score": ${{ needs.security-gate.outputs.overall-security-score }}}'
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, dependency-scan, security-gate, security-notification]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œã‚µãƒãƒªãƒ¼"
          echo ""
          echo "**ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ã‚¤ãƒ—**: ${{ env.SCAN_TYPE }}"
          echo "**é™çš„è§£æ**: ${{ needs.static-analysis.result }}"
          echo "**ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³**: ${{ needs.dependency-scan.result }}"
          echo "**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ**: ${{ needs.security-gate.result }}"
          echo "**é€šçŸ¥**: ${{ needs.security-notification.result }}"
          echo ""
          echo "**ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢**: ${{ needs.security-gate.outputs.overall-security-score }}/100"
          echo "**è„†å¼±æ€§æ¤œå‡º**: ${{ needs.static-analysis.outputs.vulnerabilities-found }}"
          echo "**ä¾å­˜é–¢ä¿‚è„†å¼±æ€§**: ${{ needs.dependency-scan.outputs.dependency-vulnerabilities }} ä»¶"
          echo ""
          echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y/%m/%d %H:%M:%S UTC')"
          echo "**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          # å…¨ä½“çš„ãªæˆåŠŸåˆ¤å®š
          if [[ "${{ needs.security-gate.outputs.security-gate-status }}" == "PASS" ]]; then
            echo ""
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          else
            echo ""
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi