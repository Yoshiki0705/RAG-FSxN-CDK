name: Regional Deployment Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_regions:
        description: 'Target regions for deployment (comma-separated)'
        required: false
        default: 'ap-northeast-1'
      deployment_strategy:
        description: 'Deployment strategy'
        required: false
        default: 'CANARY'
        type: choice
        options:
          - BLUE_GREEN
          - CANARY
          - ROLLING

env:
  NODE_VERSION: '20'
  AWS_REGION: ap-northeast-1
  PROJECT_NAME: permission-aware-rag

jobs:
  # å“è³ªãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    outputs:
      security-passed: ${{ steps.security.outputs.passed }}
      compliance-passed: ${{ steps.compliance.outputs.passed }}
      performance-passed: ${{ steps.performance.outputs.passed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm run build

      - name: Run linting
        run: npm run lint

      - name: Run unit tests
        run: npm run test

      - name: Security scan
        id: security
        run: |
          echo "ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."
          npm run security:scan
          echo "passed=true" >> $GITHUB_OUTPUT

      - name: Compliance check
        id: compliance
        run: |
          echo "ðŸ“‹ ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          npm run compliance:check
          echo "passed=true" >> $GITHUB_OUTPUT

      - name: Performance test
        id: performance
        run: |
          echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npm run performance:test
          echo "passed=true" >> $GITHUB_OUTPUT

      - name: Build CDK
        run: |
          npm run cdk:synth
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cdk-artifacts
          path: |
            cdk.out/
            dist/
            package.json
            package-lock.json

  # åœ°åŸŸåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¸ãƒ§ãƒ–
  deploy-regions:
    name: Deploy to Regions
    needs: quality-checks
    if: needs.quality-checks.outputs.security-passed == 'true' && 
        needs.quality-checks.outputs.compliance-passed == 'true' && 
        needs.quality-checks.outputs.performance-passed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: 
          - ap-northeast-1  # æ±äº¬
          - ap-northeast-3  # å¤§é˜ª
          - ap-southeast-1  # ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«
          - eu-central-1    # ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ
          - us-east-1       # ãƒãƒ¼ã‚¸ãƒ‹ã‚¢
      fail-fast: false
      max-parallel: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-artifacts

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ matrix.region }}

      - name: Install dependencies
        run: npm ci

      - name: Deploy to region
        run: |
          echo "ðŸš€ åœ°åŸŸåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé–‹å§‹: ${{ matrix.region }}"
          
          # åœ°åŸŸåˆ¥è¨­å®šã®é©ç”¨
          export AWS_REGION=${{ matrix.region }}
          export DEPLOYMENT_REGION=${{ matrix.region }}
          
          # CDK Bootstrapï¼ˆåˆå›žã®ã¿ï¼‰
          npx cdk bootstrap --region ${{ matrix.region }}
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Ÿè¡Œ
          npx cdk deploy --all \
            --region ${{ matrix.region }} \
            --require-approval never \
            --context region=${{ matrix.region }} \
            --context environment=${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

      - name: Post-deployment verification
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¾Œæ¤œè¨¼: ${{ matrix.region }}"
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          npm run health-check -- --region ${{ matrix.region }}
          
          # åœ°åŸŸåˆ¥ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ç¢ºèª
          npm run compliance:verify -- --region ${{ matrix.region }}

      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸ: ${{ matrix.region }}"
          else
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¤±æ•—: ${{ matrix.region }}"
          fi

  # çµ±åˆãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  integration-tests:
    name: Integration Tests
    needs: deploy-regions
    if: always() && needs.deploy-regions.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: |
          echo "ðŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          
          # åœ°åŸŸé–“é€£æºãƒ†ã‚¹ãƒˆ
          npm run test:integration:cross-region
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
          npm run test:integration:replication
          
          # ç½å®³å¾©æ—§ãƒ†ã‚¹ãƒˆ
          npm run test:integration:disaster-recovery

      - name: Generate test report
        if: always()
        run: |
          echo "ðŸ“Š ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          npm run test:report

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test-results/
            coverage/

  # æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy-production:
    name: Deploy to Production
    needs: [quality-checks, deploy-regions, integration-tests]
    if: github.ref == 'refs/heads/main' && 
        needs.quality-checks.result == 'success' && 
        needs.deploy-regions.result == 'success' && 
        needs.integration-tests.result == 'success'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm ci

      - name: Deploy to production
        run: |
          echo "ðŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé–‹å§‹"
          
          # æœ¬ç•ªç’°å¢ƒè¨­å®š
          export NODE_ENV=production
          export ENVIRONMENT=prod
          
          # æ®µéšŽçš„æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
          # Phase 1: åŸºç›¤åœ°åŸŸ
          npx cdk deploy --all \
            --context environment=prod \
            --context regions=ap-northeast-1,us-east-1 \
            --require-approval never
          
          # Phase 2: ä¸»è¦åœ°åŸŸï¼ˆ30åˆ†å¾Œï¼‰
          sleep 1800
          npx cdk deploy --all \
            --context environment=prod \
            --context regions=ap-northeast-3,eu-central-1,us-west-2 \
            --require-approval never
          
          # Phase 3: å…¨åœ°åŸŸå±•é–‹
          sleep 1800
          npx cdk deploy --all \
            --context environment=prod \
            --context regions=all \
            --require-approval never

      - name: Production verification
        run: |
          echo "âœ… æœ¬ç•ªç’°å¢ƒæ¤œè¨¼å®Ÿè¡Œä¸­..."
          
          # æœ¬ç•ªç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          npm run health-check:production
          
          # æœ¬ç•ªç’°å¢ƒãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          npm run performance:test:production
          
          # æœ¬ç•ªç’°å¢ƒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
          npm run security:verify:production

      - name: Notify production deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸ"
          else
            echo "ðŸš¨ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¤±æ•—"
          fi

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify:
    name: Notify Results
    needs: [quality-checks, deploy-regions, integration-tests, deploy-production]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Determine overall status
        id: status
        run: |
          if [ "${{ needs.quality-checks.result }}" == "success" ] && 
             [ "${{ needs.deploy-regions.result }}" == "success" ] && 
             [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=ðŸŽ‰ åœ°åŸŸåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æˆåŠŸ" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ åœ°åŸŸåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        run: |
          echo "${{ steps.status.outputs.message }}"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"