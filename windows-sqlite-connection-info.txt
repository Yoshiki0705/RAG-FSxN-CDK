# Windows SQLite UNIQUE制約エラー負荷試験 - 接続情報

## 作成されたリソース

### Windows EC2インスタンス
- インスタンスID: i-077d7a79f61f7ef83
- プライベートIP: 10.21.3.210
- インスタンスタイプ: t3.medium
- OS: Windows Server 2022

### FSx for ONTAP CIFS共有
- SVM: permission-aware-rag-prod-svm
- 共有名: sqlite-load-test
- パス: /sqlite-load-test
- IP アドレス: 10.21.3.131
- UNC パス: \\10.21.3.131\sqlite-load-test

### 踏み台サーバー
- インスタンスID: i-04b83a402ecfd5c57
- パブリックIP: 18.181.171.72
- プライベートIP: 10.21.0.7

## RDP接続方法

### 1. 踏み台サーバー経由でのRDP接続

```bash
# 踏み台サーバーにSSH接続
ssh -i "fujiwara-2025.pem" ec2-user@18.181.171.72

# 踏み台サーバーからWindowsインスタンスにRDP接続
# RDPクライアントを使用して 10.21.3.210:3389 に接続
```

### 2. Windowsパスワードの復号化

暗号化されたパスワードデータ:
```
pmOzCFkLQsAqd07D0bqKHB9cREF/Blnl7SqaaNWqJA9FmiEnZ6x8wCN62UfXpACl+je40RzEzCo4l/1iS9uOhNG56UsF2dDFc0VV5pqgS0J1WtM
xl8FjOykr9jLpwtFmsWrahbcoTUEVyDYU0HOVO+MzGaGQWkOAAqZyyEF9VtmditDK5DcS3VtUni/qAwq8zypaB5U/vHbJeTgvqzJr7ssr48A2yCXOEJGAifKwBDoERiXtjHX9T9btE0/2V5PK1FaZ+hB6re3HXq9zPHo/ZjHBZx08nWT0GSfStGtPL2xjzuqDx9fB2ps9+zQX5nHuZmVCXGT2qbPBxCnOi/YykQ==
```

AWS CLIでパスワードを復号化:
```bash
aws ec2 get-password-data --instance-id i-077d7a79f61f7ef83 --priv-launch-key fujiwara-2025.pem
```

## SQLite負荷試験の実行手順

### 1. RDP接続後の初期確認

```powershell
# 初期化状況の確認
Get-Content C:\SQLiteLoadTest\init_complete.log

# システム情報の確認
Get-ComputerInfo
```

### 2. FSx for ONTAP CIFS共有のマウント

```powershell
# PowerShellでCIFS共有をマウント
& "C:\SQLiteLoadTest\mount_fsx.ps1"

# または手動でマウント
net use Z: \\10.21.3.131\sqlite-load-test /persistent:yes

# マウント状況の確認
Get-PSDrive -PSProvider FileSystem
dir Z:\
```

### 3. 簡単な負荷試験の実行

```powershell
# 軽い負荷試験（10スレッド、1000操作）
& "C:\SQLiteLoadTest\run_quick_test.ps1"
```

### 4. カスタム負荷試験の実行

```powershell
# 中程度の負荷試験（20スレッド、5000操作）
python "C:\SQLiteLoadTest\unique_constraint_test.py" "Z:\medium_test.db" 20 5000

# 高負荷試験（50スレッド、10000操作）
python "C:\SQLiteLoadTest\unique_constraint_test.py" "Z:\heavy_test.db" 50 10000

# 極端な負荷試験（100スレッド、20000操作）
python "C:\SQLiteLoadTest\unique_constraint_test.py" "Z:\extreme_test.db" 100 20000
```

## 負荷試験の目的

この負荷試験は以下を検証します：

1. **UNIQUE制約エラーの発生頻度**
   - 並行書き込み時のUNIQUE制約違反の発生パターン
   - エラー率とスループットの関係

2. **FSx for ONTAP CIFS共有の性能**
   - SMB/CIFS経由でのSQLiteデータベース操作性能
   - 並行アクセス時のI/O性能

3. **SQLite WALモードの効果**
   - Write-Ahead Loggingによる並行性の向上
   - ロック競合の軽減効果

4. **Windows環境での性能特性**
   - Windows Server 2022でのSQLite性能
   - CIFS共有上でのデータベース操作の安定性

## 結果の確認

```powershell
# 結果ファイルの確認
Get-ChildItem Z:\*.results.txt
Get-Content Z:\quick_test.db.results.txt

# データベースサイズの確認
Get-ChildItem Z:\*.db | Select-Object Name, Length

# システムリソース使用状況
Get-Process | Sort-Object CPU -Descending | Select-Object -First 10
```

## トラブルシューティング

### CIFS共有マウントエラー
```powershell
# 既存のマッピングを削除
net use Z: /delete

# 再マウント
net use Z: \\10.21.3.131\sqlite-load-test /persistent:yes

# 接続テスト
Test-NetConnection -ComputerName 10.21.3.131 -Port 445
```

### Python実行エラー
```powershell
# Python環境の確認
python --version
pip list

# 依存関係の再インストール
pip install --upgrade psutil
```

### SQLiteエラー
```powershell
# データベースファイルの権限確認
Get-Acl Z:\test.db

# 一時ファイルの削除
Remove-Item Z:\*.db-wal, Z:\*.db-shm -Force
```

## 期待される結果

- **成功率**: 60-80% (UNIQUE制約エラーが意図的に発生)
- **UNIQUE制約エラー率**: 20-40%
- **スループット**: 50-200 ops/sec (CIFS経由のため若干低下)
- **レスポンス時間**: 数ミリ秒～数十ミリ秒

## 注意事項

- この負荷試験は意図的にUNIQUE制約エラーを発生させます
- 実際のプロダクション環境では使用しないでください
- 試験完了後はインスタンスを停止/削除してください
- 機密データは使用しないでください

## 次のステップ

1. RDP接続してWindows環境にアクセス
2. CIFS共有のマウント確認
3. 基本的な負荷試験を実行
4. 結果を分析してパフォーマンス特性を把握
5. 異なるパラメータで複数回実行
6. FSx for ONTAP CIFS共有の性能特性をドキュメント化
7. 必要に応じて追加の最適化を実施